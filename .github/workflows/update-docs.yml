# Automated Documentation Updates
# Updates documentation when code is merged to main
#
# Setup: Add FACTORY_API_KEY to repository secrets

name: Auto-Update Documentation

on:
  push:
    branches: [main]
    paths:
      - 'src/**/*.py'
      - 'scripts/**/*.py'
      - '!**/*_test.py'
      - '!**/test_*.py'

jobs:
  update-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup droid CLI
        run: |
          curl -fsSL https://app.factory.ai/cli | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Get changed files
        id: changes
        run: |
          git diff --name-only HEAD^ HEAD > changed_files.txt
          echo "Files changed in last commit:"
          cat changed_files.txt

      - name: Update documentation
        env:
          FACTORY_API_KEY: ${{ secrets.FACTORY_API_KEY }}
        run: |
          cat > doc_update_prompt.txt << 'EOF'
          The following source files were just merged to main:

          $(cat changed_files.txt)

          Your task is to update the documentation to match these code changes.

          ## Step 1: Explore the codebase
          1. Examine pyproject.toml, README.md, and main entry points
          2. Identify key directories and their purposes
          3. Note the tech stack (Python, FastAPI, Docker, Coolify)
          4. This is a Fabrik project - a deployment automation CLI

          ## Step 2: Understand what changed
          1. Read each changed file carefully
          2. Identify if changes are: API updates, new features, bug fixes, refactors
          3. Note breaking changes or new configuration options

          ## Step 3: Find and update relevant documentation
          1. Search these locations for docs that reference changed code:
             - docs/ directory
             - README.md
             - AGENTS.md
             - docstrings in the changed files
          2. Update the found documentation:
             - Update function signatures if they changed
             - Update code examples to match new APIs
             - Update configuration docs if options changed
             - Add notes about breaking changes if needed
          3. Preserve the existing doc structure and writing style
          4. Only modify sections that are actually affected

          DO NOT commit or push changes.

          ## Step 4: Create summary
          Create doc-update-summary.md with:
          - List of documentation files that were updated
          - Summary of changes made to each file
          - Any sections that may need human review
          EOF

          droid exec --auto low \
            --model gemini-3-flash-preview \
            -f doc_update_prompt.txt

      - name: Commit documentation updates
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "docs: automated documentation updates"
          else
            echo "No documentation changes needed"
            exit 0
          fi

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="docs/auto-update-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH
          git push origin $BRANCH

          # Get summary or use default message
          SUMMARY=$(cat doc-update-summary.md 2>/dev/null || echo "Documentation updated to reflect recent code changes.")

          gh pr create \
            --title "ðŸ“š Automated documentation updates" \
            --body "## Automated Documentation Updates

          $SUMMARY

          ### Review Checklist
          - [ ] Documentation accurately reflects code changes
          - [ ] Code examples are correct and runnable
          - [ ] No unintended changes to other sections
          - [ ] Formatting and style are consistent

          ---
          *This PR was automatically generated after code was merged to main.*" \
            --label "documentation,automated"
