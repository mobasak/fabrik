# Fabrik Codebase Fixes - CORE

**Plan:** 1 of 6
**Created:** 2026-01-09
**Module:** `core`

## Summary

| Type | Count |
|------|-------|
| P0 (Critical) | 24 |
| P1 (Important) | 42 |
| Hardcoded Values | 55 |
| Files | 11 |

---

## Safety Rules (From Fabrik Rules)

### Before Each Fix
1. **Read current code** - Understand existing behavior
2. **Preserve signatures** - No breaking API changes
3. **Use env vars with defaults** - `os.getenv('VAR', 'current_value')`
4. **Run tests after** - `pytest tests/ -v`

### Fix Patterns

| Issue Type | Safe Fix Pattern |
|------------|------------------|
| Hardcoded IP/URL | `os.getenv('VAR_NAME', 'current_hardcoded_value')` |
| Hardcoded path | `Path(os.getenv('FABRIK_ROOT', '/opt/fabrik'))` |
| Missing error handling | Wrap in try/except, log error, re-raise |
| Command injection | Use `shlex.quote()` on user inputs |
| Path traversal | Add `.resolve()` + startswith check |

### After Each Fix
```bash
# 1. Run affected tests
pytest tests/ -k 'test_name' -v

# 2. Verify import works
python3 -c 'from src.fabrik.module import func; print("OK")'
```

### How to Skip Items

Add `[skip]` after any checkbox: `- [ ] [skip] Item...`

---

## `src/fabrik/cli.py`

**Summary:** The CLI is in a transitional state with mixed responsibilities. It tightly couples the tool to specific infrastructure (hardcoded IP) and filesystem layouts (/opt/fabrik), while several flags like --f...

### P0 Issues (Critical)

- [ ] **1.** Hardcoded production IP address '172.93.160.197' used for DNS records in 'apply' and 'verify' commands

  **HOW TO FIX:** `os.getenv("VPS_IP", "172.93.160.197")`
  **SAFE:** Default preserves current behavior.

- [ ] **2.** The 'logs --follow' functionality is unimplemented and only returns a static snapshot of logs

  **HOW TO FIX:** Either implement the feature OR raise explicit NotImplementedError with helpful message.
  **SAFE:** Explicit error better than silent failure.

- [ ] **3.** DNS record removal is unimplemented in the 'destroy' command

  **HOW TO FIX:** Either implement the feature OR raise explicit NotImplementedError with helpful message.
  **SAFE:** Explicit error better than silent failure.

- [ ] **4.** Hardcoded absolute paths to '/opt/fabrik' in 'templates', 'verify', and 'sync-models' commands limit portability

  **HOW TO FIX:** `Path(os.getenv("FABRIK_ROOT", "/opt/fabrik"))`
  **SAFE:** Default preserves current behavior.

### P1 Issues (Important)

- [ ] **5.** Significant business logic (DNS creation, Coolify orchestration) is mixed directly into CLI functions

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **6.** Secret parsing logic (KEY=VALUE splitting) is duplicated between 'plan' and 'apply' commands

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **7.** Inconsistent deployment paths: 'apply' contains both a 'Legacy path' and a 'New orchestrator' path

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **8.** Ineffectual code in 'destroy' command where subdomain/base_domain strings are joined but not assigned or used (lines 352-353)

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

### Hardcoded Values

- [ ] **9.** `172.93.160.197 (VPS IP)`
  **HOW TO FIX:** `os.getenv('VPS_IP', '172.93.160.197')`

- [ ] **10.** `/opt/fabrik/templates/ (Template directory)`
  **HOW TO FIX:** `Path(os.getenv('FABRIK_ROOT', '/opt/fabrik'))`

- [ ] **11.** `/opt/fabrik/specs/verification/ (Verification specs)`
  **HOW TO FIX:** `Path(os.getenv('FABRIK_ROOT', '/opt/fabrik'))`

- [ ] **12.** `0.1.0 (Version string)`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **13.** `specs (Default output directory)`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

---

## `src/fabrik/compose_linter.py`

**Summary:** The linter provides essential checks for Coolify compatibility but contains a logic flaw in variable validation and uses overly restrictive regex patterns that could miss valid configuration issues....

### P0 Issues (Critical)

- [ ] **14.** Variable detection logic bug: unresolved variables are masked if the same variable name is used elsewhere in the file with a default value due to set subtraction on names rather than tracking occurrences.

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **15.** Variable regex is restricted to uppercase (A-Z), failing to detect valid lowercase or mixed-case environment variables.

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **16.** Linter does not detect $VAR syntax (without braces), which is valid in Docker Compose and likely subject to the same reliability issues in Coolify.

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

### P1 Issues (Important)

- [ ] **17.** Database detection for healthcheck warnings uses a limited hardcoded list (mysql, postgres, etc.) and may miss other common databases or custom images.

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **18.** Raw string scanning for variables can lead to false positives by matching patterns in comments or literal strings not intended for interpolation.

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **19.** The linter lacks validation for other common Coolify failure points such as local 'build' contexts or incompatible 'volumes' path mappings.

  **HOW TO FIX:**
  ```python
  # Validate path stays within allowed directory
  resolved = (base_dir / user_path).resolve()
  if not str(resolved).startswith(str(base_dir.resolve())):
      raise ValueError(f"Path traversal attempt: {user_path}")
  ```
  **SAFE:** Blocks malicious paths, valid paths unaffected.

### Hardcoded Values

- [ ] **20.** `Database engine keywords: mysql, mariadb, postgres, mongo, redis`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **21.** `Recommended restart policy: unless-stopped`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **22.** `Regex patterns for variable substitution matching`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

---

## `src/fabrik/config.py`

**Summary:** The configuration module is a basic environment wrapper lacking robust validation, singleton pattern, and automated directory initialization. It relies on external callers to load environment variable...

### P0 Issues (Critical)

- [ ] **23.** No automatic loading of .env file within config.py (requires manual load_dotenv() call in every entry point)

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **24.** Sensitive credentials (VPS_SSH_KEY, COOLIFY_API_TOKEN) are stored as plain strings in the Config object without encryption or secure handling

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **25.** Missing validation for URL formats (COOLIFY_API_URL, NAMECHEAP_API_URL) which could lead to runtime errors in drivers

  **HOW TO FIX:** Add validation that fails fast with clear error message.
  **SAFE:** Early failure with helpful error.

### P1 Issues (Important)

- [ ] **26.** Config class is not a singleton, leading to multiple environment reads if instantiated multiple times

  **HOW TO FIX:** Add module-level singleton pattern with `get_instance()` function.
  **SAFE:** New function, existing direct instantiation still works.

- [ ] **27.** ensure_directories() is defined but never called within the module or the Config class

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **28.** to_dict() method is incomplete, missing several fields like vps_ssh_key and coolify_token

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **29.** Type hints for get_env allow str | None but Config attributes assume str for required fields without explicit casting/assertion

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **30.** Hardcoded default for VPS_SSH_KEY (~/.ssh/id_rsa) may not be appropriate for all environments (e.g., Docker containers)

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

### Hardcoded Values

- [ ] **31.** `~/.ssh/id_rsa (default VPS_SSH_KEY)`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **32.** `deploy (default VPS_USER)`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **33.** `namecheap (default DNS_PROVIDER)`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **34.** `https://namecheap.vps1.ocoron.com (default NAMECHEAP_API_URL)`
  **HOW TO FIX:** Move to env var with current URL as default

- [ ] **35.** `INFO (default LOG_LEVEL)`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **36.** `json (default LOG_FORMAT)`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

---

## `src/fabrik/deploy.py`

**Summary:** The script is a basic helper that lacks the robustness required for production deployments, primarily due to risky server selection logic and hardcoded configurations....

### P0 Issues (Critical)

- [ ] **37.** Dangerous fallback to the first available server (servers[0]) if COOLIFY_SERVER_UUID is not set, potentially deploying to the wrong environment.

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **38.** Total lack of error handling (try/except) for network requests and Coolify API failures.

  **HOW TO FIX:**
  ```python
  try:
      # existing code
  except SpecificException as e:
      logger.error(f"Operation failed: {e}")
      raise  # Re-raise with context
  ```
  **SAFE:** Adds error handling, no behavior change on success.

### P1 Issues (Important)

- [ ] **39.** No logging of deployment progress or decision-making logic.

  **HOW TO FIX:** Add `logger.info()` / `logger.error()` at key points.
  **SAFE:** Additive, no behavior change.

- [ ] **40.** Project name and description are hardcoded, limiting multi-project support.

  **HOW TO FIX:** `os.getenv("VPS_IP", "172.93.160.197")`
  **SAFE:** Default preserves current behavior.

- [ ] **41.** Deployment behavior (force=True, instant_deploy=True) is hardcoded and cannot be configured per app.

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

### Hardcoded Values

- [ ] **42.** `"fabrik"`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **43.** `"Fabrik apps"`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **44.** `force=True`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **45.** `instant_deploy=True`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

---

## `src/fabrik/main.py`

**Summary:** The file is a minimal wrapper that delegates execution to fabrik.cli.main. While functional, the manual documentation in the docstring has not been maintained as the CLI evolved, potentially misleadin...

### P1 Issues (Important)

- [ ] **46.** The module docstring contains a 'Usage' section that is severely outdated, listing only 5 commands while the actual CLI implementation in cli.py supports 14 commands (missing logs, destroy, projects, scan, scaffold, validate, fix, verify, sync-models).

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **47.** Redundant entry point logic: the 'if __name__ == "__main__": main()' block is duplicated in both main.py and cli.py, which can lead to confusion about the primary entry point.

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

### Hardcoded Values

- [ ] **48.** `Hardcoded CLI command names and usage examples in the module docstring which have become stale compared to the implementation in cli.py.`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

---

## `src/fabrik/provisioner.py`

**Summary:** The provisioner implements a saga pattern for site deployment but is currently broken; it contains several NotImplementedError placeholders in the critical path and fails to invoke its own polling and...

### P0 Issues (Critical)

- [ ] **49.** _step2_set_env_vars and _step2_wait_healthy raise NotImplementedError but are required steps in the _run_saga flow

  **HOW TO FIX:** Either implement the feature OR raise explicit NotImplementedError with helpful message.
  **SAFE:** Explicit error better than silent failure.

- [ ] **50.** _step2_poll_deployment and _step2_verify_http methods are defined but never actually called within the _run_saga execution loop

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **51.** ProvisionJob.from_dict explicitly sets contact to None, which breaks domain registration resumption if the original request object is missing

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **52.** The saga transitions directly from STEP2_DEPLOY_TRIGGERED to a NotImplemented wait step, skipping the actual polling logic

  **HOW TO FIX:** Either implement the feature OR raise explicit NotImplementedError with helpful message.
  **SAFE:** Explicit error better than silent failure.

### P1 Issues (Important)

- [ ] **53.** Synchronous time.sleep(30) in _gate_wait_cf_active blocks the execution thread during DNS propagation

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **54.** WP admin password is generated and stored but not passed into the compose template or used for automated installation

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **55.** Mixing legacy state aliases with new states in the Enum causes confusion in the saga transition logic

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

### Hardcoded Values

- [ ] **56.** `DNS_MANAGER_URL: https://dns.vps1.ocoron.com`
  **HOW TO FIX:** Move to env var with current URL as default

- [ ] **57.** `VPS_IP: 172.93.160.197`
  **HOW TO FIX:** `os.getenv('VPS_IP', '172.93.160.197')`

- [ ] **58.** `VPS_SERVER_UUID: jk4wskkcks8csg4gcokwgw8s`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

---

## `src/fabrik/registry.py`

**Summary:** The registry manages project metadata in YAML format. It features a scanning mechanism for the /opt directory but relies heavily on hardcoded paths and lacks robust error handling for file I/O and OS-...

### P1 Issues (Important)

- [ ] **59.** scan() lacks error handling for permission denied when iterating over /opt

  **HOW TO FIX:**
  ```python
  try:
      # existing code
  except SpecificException as e:
      logger.error(f"Operation failed: {e}")
      raise  # Re-raise with context
  ```
  **SAFE:** Adds error handling, no behavior change on success.

- [ ] **60.** ProjectRegistry.save() overwrites the entire file without atomicity (risk of data loss if process killed during write)

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **61.** ProjectRegistry._load() does not handle yaml.YAMLError

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **62.** Project.to_dict() return type hint dict[str, str | int] is inconsistent with from_dict which accepts any data

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

### Hardcoded Values

- [ ] **63.** `/opt/fabrik/data/projects.yaml`
  **HOW TO FIX:** `Path(os.getenv('FABRIK_ROOT', '/opt/fabrik'))`

- [ ] **64.** `/opt`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **65.** `['_*', '.*', 'google', 'apps', '__pycache__', 'venv']`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **66.** `service`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **67.** `development`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

---

## `src/fabrik/scaffold.py`

**Summary:** A project scaffolding utility that generates a FastAPI project structure with Git integration and documentation templates. It is tightly coupled to the /opt/fabrik directory structure and assumes a sp...

### P0 Issues (Critical)

- [ ] **68.** Hardcoded absolute paths (/opt/fabrik) throughout the module prevent portability and make testing in non-root environments difficult

  **HOW TO FIX:** `Path(os.getenv("FABRIK_ROOT", "/opt/fabrik"))`
  **SAFE:** Default preserves current behavior.

- [ ] **69.** Git commit operation in create_project() will fail in environments where git user.name and user.email are not pre-configured

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

### P1 Issues (Important)

- [ ] **70.** Redundant import of 'date' inside fix_project() function

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **71.** Inconsistent template replacement patterns between create_project() and fix_project() (e.g., project-name is missing in fix_project)

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **72.** Lack of centralized logging (uses direct file writes and subprocess output capturing only)

  **HOW TO FIX:** Add `logger.info()` / `logger.error()` at key points.
  **SAFE:** Additive, no behavior change.

- [ ] **73.** Symlink operations may fail on filesystems or OS configurations that do not support them without specific permissions

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

### Hardcoded Values

- [ ] **74.** `/opt/fabrik`
  **HOW TO FIX:** `Path(os.getenv('FABRIK_ROOT', '/opt/fabrik'))`

- [ ] **75.** `/opt`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **76.** `/opt/fabrik/templates/scaffold`
  **HOW TO FIX:** `Path(os.getenv('FABRIK_ROOT', '/opt/fabrik'))`

- [ ] **77.** `/opt/fabrik/AGENTS.md`
  **HOW TO FIX:** `Path(os.getenv('FABRIK_ROOT', '/opt/fabrik'))`

- [ ] **78.** `fastapi>=0.109.0`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **79.** `uvicorn[standard]>=0.27.0`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **80.** `postgresql://localhost:5432/`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

---

## `src/fabrik/spec_loader.py`

**Summary:** The module provides a solid Pydantic-based schema for deployment specs with effective model-level validation for source types. Enhancing string-based resource and duration fields with regex or custom ...

### P1 Issues (Important)

- [ ] **81.** Resources memory and cpu fields lack strict format validation (e.g., regex for '256M' or '0.5')

  **HOW TO FIX:** Add validation that fails fast with clear error message.
  **SAFE:** Early failure with helpful error.

- [ ] **82.** Health interval and timeout strings lack duration format validation

  **HOW TO FIX:** Add validation that fails fast with clear error message.
  **SAFE:** Early failure with helpful error.

- [ ] **83.** save_spec's use of exclude_defaults=True may strip explicit user configurations that happen to match defaults

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **84.** DNSRecord.type is a raw string instead of an Enum or Literal despite having a fixed set of supported types

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **85.** CoolifyConfig.server defaults to 'localhost', which may be an unsafe or incorrect default for production environments

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **86.** validate_id's v.lower() is redundant as the Field regex already enforces lowercase characters

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

### Hardcoded Values

- [ ] **87.** `Resources.memory: '256M'`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **88.** `Resources.cpu: '0.5'`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **89.** `Health.path: '/health'`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **90.** `Health.interval: '30s'`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **91.** `Health.timeout: '10s'`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **92.** `Backup.retention: 30`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **93.** `CoolifyConfig.server: 'localhost'`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **94.** `CoolifyConfig.project: 'default'`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **95.** `Source.branch: 'main'`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **96.** `DNSRecord.ttl: 1800`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

---

## `src/fabrik/template_renderer.py`

**Summary:** Core Jinja2 rendering logic with significant security risks regarding path traversal and secret leakage in generated example files. Lacks validation for template names and proper shell escaping....

### P0 Issues (Critical)

- [ ] **97.** Path Traversal: 'spec.template' is used in path construction without validation, allowing access to directories outside 'templates_dir'.

  **HOW TO FIX:**
  ```python
  # Validate path stays within allowed directory
  resolved = (base_dir / user_path).resolve()
  if not str(resolved).startswith(str(base_dir.resolve())):
      raise ValueError(f"Path traversal attempt: {user_path}")
  ```
  **SAFE:** Blocks malicious paths, valid paths unaffected.

- [ ] **98.** Sensitive Data Exposure: 'spec.env' values are written in plain text to '.env.example' without filtering for potential secrets or sensitive keys.

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **99.** Insecure Directory Creation: '__init__' and 'render' methods create directories and files at arbitrary paths if 'templates_dir', 'output_dir', or 'spec.id' are maliciously crafted.

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

### P1 Issues (Important)

- [ ] **100.** Synchronous blocking I/O: Uses 'open', 'mkdir', and 'Path.glob' synchronously, which may block the event loop in an async/FastAPI environment.

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **101.** Inconsistent Return Types: 'render' returns rendered content (Dict[str, str]) on 'dry_run', but file paths (Dict[str, str]) otherwise.

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **102.** Fragile Shell Escaping: '_env_escape' only handles double quotes and newlines, leaving other shell-special characters (like '$', '`', or '\') unescaped.

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **103.** Broken .env.example: Environment values in '.env.example' are not escaped, which will result in invalid files if values contain newlines or special characters.

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

### Hardcoded Values

- [ ] **104.** `/opt/fabrik/templates (implied via fabrik_root/templates)`
  **HOW TO FIX:** `Path(os.getenv('FABRIK_ROOT', '/opt/fabrik'))`

- [ ] **105.** `/opt/fabrik/apps (implied via fabrik_root/apps)`
  **HOW TO FIX:** `Path(os.getenv('FABRIK_ROOT', '/opt/fabrik'))`

- [ ] **106.** `compose.yaml.j2`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **107.** `Dockerfile.j2`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **108.** `defaults.yaml`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **109.** `.env.example`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

---

## `src/fabrik/verify.py`

**Summary:** The module provides a functional framework for post-deployment checks but relies on hardcoded infrastructure defaults and contains placeholders for critical features like SSL expiry validation and rol...

### P0 Issues (Critical)

- [ ] **110.** Hardcoded IP address '172.93.160.197' used as default TARGET_IP in verify_postconditions

  **HOW TO FIX:** `os.getenv("VPS_IP", "172.93.160.197")`
  **SAFE:** Default preserves current behavior.

- [ ] **111.** Incomplete implementation: 'check_ssl' retrieves certificate but lacks actual expiry validation logic (marked as TODO in comments)

  **HOW TO FIX:** Add validation that fails fast with clear error message.
  **SAFE:** Early failure with helpful error.

- [ ] **112.** Missing rollback execution: 'verify_postconditions' triggers a warning and raises RuntimeError but contains no actual rollback implementation logic

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

### P1 Issues (Important)

- [ ] **113.** Fragile variable substitution in '_load_spec' using simple string replacement which can cause collisions

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **114.** The 'verify_postconditions' decorator assumes wrapped function returns a dict, which may cause errors if it returns None or other types

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **115.** Inefficient usage of 'httpx.Client' within the retry loop of 'check_http'

  **HOW TO FIX:** Review and apply minimal fix preserving existing behavior.
  **SAFE:** Will verify with tests before and after.

- [ ] **116.** Multiple hardcoded paths for spec resolution in 'get_spec_path' and 'verify_postconditions'

  **HOW TO FIX:** `os.getenv("VPS_IP", "172.93.160.197")`
  **SAFE:** Default preserves current behavior.

### Hardcoded Values

- [ ] **117.** `172.93.160.197 (Default VPS_IP)`
  **HOW TO FIX:** `os.getenv('VPS_IP', '172.93.160.197')`

- [ ] **118.** `/opt/fabrik (Default FABRIK_ROOT and fallback spec path)`
  **HOW TO FIX:** `Path(os.getenv('FABRIK_ROOT', '/opt/fabrik'))`

- [ ] **119.** `Port 443 (SSL check)`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

- [ ] **120.** `Default timeout (30s) and retries (3) for HTTP checks`
  **HOW TO FIX:** Move to env var with current URL as default

- [ ] **121.** `Default retries (5) for DNS checks`
  **HOW TO FIX:** Keep as constant OR move to config if needs customization

---

## Execution Instructions

1. Review all items above
2. Mark items to skip with `[skip]`
3. Say: **"Execute core plan"**

### Verification After Each File

```bash
# After fixing each file:
python3 -m py_compile <file>  # Syntax check
pytest tests/ -v              # Run tests
python3 -m scripts.enforcement.validate_conventions --strict <file>
```
